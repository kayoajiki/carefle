# 機能追加・改善履歴（2025年12月18日〜19日）

## 1. プロフィール管理機能の拡張

### 1.1 プロフィール編集機能の実装
- **プロフィール編集ページの日本語化と機能拡張**
  - `/settings/profile`ページを完全に日本語化
  - 初期登録時に設定したすべてのプロフィール情報（生年月日、性別、都道府県、職業、業界、雇用形態、勤続年数、学歴）を編集可能に
  - サイドバーに「プロフィール」リンクを追加（「履歴書アップロード」の上に配置）

### 1.2 プロフィール設定フォームの改善
- **雇用形態フィールドの追加**
  - 「雇用形態」フィールドを追加（正社員、契約社員、派遣社員、業務委託・フリーランス、パート・アルバイト、その他）
  - データベースに`employment_type`カラムを追加するマイグレーションを実装

- **勤続年数の拡張**
  - 「現在は働いていない」オプションを追加
  - `work_experience_years`カラムを`integer`型から`string`型に変更するマイグレーションを実装（`'not_working'`値をサポート）

### 1.3 管理画面プロフィール統計機能
- **プロフィール統計ページの実装**
  - 性別、都道府県、職業、業界、雇用形態、勤続年数、学歴の分布をグラフとテーブルで表示
  - 期間フィルター機能（開始日・終了日を指定して集計）
  - CSVエクスポート機能
  - Chart.jsを使用した視覚的なデータ表示
  - プロフィール完了済みユーザーのみを対象に集計
  - サイドバーの「管理」セクションに「プロフィール統計」リンクを追加

## 2. 管理画面機能（全体概要）

### 2.1 管理画面の構成
管理画面は管理者（`is_admin = true`）のみがアクセス可能で、以下の機能を提供します：

- **管理ダッシュボード** (`/admin/dashboard`)
  - アクティブユーザー統計（今日、今週、今月）
  - 新規ユーザー登録数（今日、今週、今月）
  - 主要操作統計（診断完了数、日記作成数）
  - 最近のアクティビティ（最新20件）

- **ユーザー管理** (`/admin/users`)
  - ユーザー一覧表示（検索、フィルター、ソート機能付き）
  - ユーザー詳細表示（プロフィール情報、診断結果、日記、WCMシート、オンボーディング進捗）
  - ユーザー編集（プロフィール情報の更新）
  - ユーザー削除

- **プロフィール統計** (`/admin/profile-stats`) ※今回追加
  - 性別、都道府県、職業、業界、雇用形態、勤続年数、学歴の分布を可視化
  - 期間フィルター機能
  - CSVエクスポート機能

- **アクティビティログ** (`/admin/activity-logs`)
  - すべてのユーザーアクションの記録を表示
  - ユーザー、アクション、日付範囲でのフィルター機能
  - CSVエクスポート機能

### 2.2 管理画面へのアクセス
- サイドバーの「管理」セクションから各機能にアクセス可能
- 管理者権限を持つユーザーのみ表示・アクセス可能
- すべての管理画面ルートは`admin`ミドルウェアで保護

## 4. 認証機能の実装と調整

### 4.1 Google認証機能の実装（一時的に無効化）
- **Laravel Socialiteを使用したGoogle OAuth認証**
  - Google認証ボタンをログイン・登録画面に追加
  - `google_id`と`avatar`カラムを`users`テーブルに追加
  - アクティビティログにGoogleログイン・登録を記録
  - 現在は一時的にコメントアウト（本番環境での設定完了後に有効化予定）

### 4.2 メール認証機能の実装（一時的に無効化）
- **Laravel Fortifyを使用したメール認証**
  - メール認証通知のカスタムテンプレート（日本語化）
  - メール認証画面の日本語化とUI改善
  - メール送信が設定されていない場合はスキップするロジックを追加
  - 現在は一時的にコメントアウト（メール設定完了後に有効化予定）

## 5. ダッシュボードUI/UXの改善

### 5.1 カード配置と統合の最適化
- **カードの統合と再配置**
  - 「内省習慣化」「あなたのゴールイメージ」「マイルストーン進捗」を1つのカードに統合
  - 「マイルストーン進捗」カードを「現職満足度診断」カードの上に移動
  - 「内省の習慣化」カードを「次のステップ」カードの下に配置（後に元の位置に戻す）

### 5.2 ボタン配置の調整
- **ボタンの移動と統合**
  - 「今日の内省を始める」ボタンを「日記進捗」カード内の「内省を始める」ボタンの位置に移動
  - 「日記カレンダー」ボタンを「内省を始める」ボタンの右側に配置
  - 「マイゴール」ボタンを「あなたのゴールイメージ」セクション内に移動
  - 「マイルストーン」ボタンを「マイルストーン進捗」セクション内に移動
  - ダッシュボードヘッダーから「マイゴール」ボタンを削除

### 5.3 レスポンシブデザインの改善
- **iPhoneサイズ対応の最適化**
  - テキストサイズとボタンサイズをiPhoneサイズに最適化
  - 「次のステップ」カード内の6つのアイテムの高さを統一（`h-full`, `min-h-[100px]`, `justify-between`を使用）
  - 「持ち味レポまで」の日付表示のオーバーフローを修正

### 5.4 トピックスメッセージの移動
- **メッセージ表示位置の変更**
  - モバイルヘッダーからトピックスメッセージを削除
  - 「次のステップ」セクションの「すべてのステップが完了しました！」メッセージの位置にトピックスメッセージを表示
  - 例：「日記16日連続記録中！素晴らしい継続力ですね🎉」

## 6. マイルストーン機能の改善

### 6.1 マイルストーン機能の簡素化
- **ミニマンダラ機能の削除**
  - マイルストーンから「ミニマンダラ」機能を削除
  - フォームをシンプルに再構築

### 6.2 行動メモ自動生成機能
- **AIによる行動メモ自動生成**
  - マイルストーンのタイトル、目標日、テーマ、サマリーから自動的に行動メモを生成
  - 最大3件まで自動生成（手動追加も可能）
  - 生成された行動メモに「AIが生成した内容です。内容を確認してください。」という注意書きを表示
  - `ActionItemGeneratorService`に`generateActionItemsFromMilestone()`メソッドを追加

### 6.3 マイルストーン管理機能の追加
- **編集・削除・完了ボタンの追加**
  - 各マイルストーンアイテムに「編集」「削除」「完了」ボタンを追加
  - 「完了」ボタンをクリックすると、マイルストーンがアクティブリストから削除され、「完了したマイルストーン」セクションに移動
  - 完了したマイルストーンは別途表示可能

### 6.4 マイルストーン表示の最適化
- **ダッシュボードでの表示ロジック**
  - ダッシュボードの「マイルストーン進捗」セクションに1つのマイルストーンのみ表示
  - 表示優先順位：目標日が最も近い → 完了率が最も低い（目標日が最も近いものが100%完了している場合は、次に完了率が低いものを表示）
  - マイルストーン一覧ページに完了率バーを追加
  - 「詳細を見る」ボタンを削除

## 7. 日記・内省機能の改善

### 7.1 日記機能の常時利用可能化
- **オンボーディング進捗に関係なく日記機能を利用可能に**
  - `FeatureDiscoveryService`の`isFeatureUnlocked()`メソッドを修正し、`'diary'`機能が常に`true`を返すように変更
  - サイドバーの条件分岐を削除し、すべてのユーザーが日記機能にアクセス可能に

### 7.2 内省チャットの改善
- **プロンプトの統合**
  - 内省チャットの2通目と3通目のプロンプトを1つに統合
  - 分類確認と事実質問を1つのAI応答にまとめることで、会話の流れをスムーズに
  - `ReflectionChatService::generateFactQuestion()`を修正し、分類確認を含むプロンプトに変更

### 7.3 日記チャット画面の改善
- **AIアバターアイコンの変更**
  - 日記チャット画面のAIアバターアイコンを「キャリくま」に変更
  - 「保存して閉じる」ボタンのテキストを「保存して閉じる（日記に保存されます）」に変更（括弧内のテキストは小さく表示）

### 7.4 アクション提案機能の一時的な無効化
- **「アクション提案」ボタンのコメントアウト**
  - 日記フォームの「アクション提案」ボタンとその機能を一時的に無効化
  - 将来的な再実装に備えてコードは保持

## 8. オンボーディング機能の改善

### 8.1 オンボーディング進捗バーの改善
- **ラベルとタイトルの変更**
  - 「オンボーディング進捗」のタイトルを「スタートガイド：7日間の内省で自分の持ち味を発見しよう」に変更（2行表示、2行目のフォントサイズを調整）
  - サブタイトルを「診断と7日間の内省で自分の持ち味を発見しよう」に変更
  - 「診断」ラベルを「現職満足度診断」に変更
  - 「3日間記録」を「3日間日記」に変更
  - 「7日間記録」を「7日間日記」に変更
  - 「自己診断」を「自己診断結果入力」に変更
  - 「持ち味レポ」を「持ち味レポ🎁」に変更

### 8.2 オンボーディング進捗カレンダーの修正
- **カレンダー表示の調整**
  - 本日の日付を一番左に表示し、その後の7日間を表示するように修正
  - 以前は過去の日付も表示されていたが、未来7日間のみを表示

### 8.3 オンボーディング完了メッセージの調整
- **完了メッセージの表示期間制限**
  - 「🎉 オンボーディング完了！」メッセージを表示してから1週間後に自動的に非表示にする機能を実装

## 9. 持ち味レポ（Strengths Report）機能の改善

### 9.1 持ち味レポの更新制限機能
- **1ヶ月更新制限の実装**
  - 初回生成以降、持ち味レポは1ヶ月に1回のみ更新可能
  - 更新可能になるまで、最後に生成されたレポが常に表示される
  - `StrengthsReport`モデルに`canUpdate()`メソッドを追加
  - 更新可能日を表示するUIを追加

### 9.2 持ち味レポ生成条件の修正
- **7日間日記完了の必須化**
  - 持ち味レポ生成時に、7日間の日記記録が完了していることを必須条件として追加
  - `OnboardingController::showMiniManual()`、`downloadMiniManualPdf()`、`updateMiniManual()`メソッドを修正

### 9.3 持ち味レポデータ構造の拡張
- **診断レポートと日記レポートの追加**
  - `strengths_reports`テーブルに`diagnosis_report`と`diary_report`カラムを追加
  - 診断結果と日記分析結果を個別に保存可能に

## 10. ゲーミフィケーション機能の改善

### 10.1 メダルレベル基準の更新
- **各項目のメダルレベル基準を再定義**
  - **日記（current_diaries）**
    - 銅：7日間記録完了（オンボーディング完了）
    - 銀：30日間記録完了
    - 金：90日間記録完了
    - プラチナ：180日間記録完了
  - **マイルストーン（milestones）**
    - 銅：1件設定してその全ての行動を完了済み
    - 銀：3件設定してその全ての行動を完了済み
    - 金：5件設定してその全ての行動を完了済み
    - プラチナ：10件設定してその全ての行動を完了済み

### 10.2 アラート機能の改善
- **アラート説明の詳細化**
  - ツールチップのアラート説明に「アラート：」ラベルを追加
  - 各項目ごとに具体的な期間を表示（例：「アラート：6ヶ月（180日）」）
  - 各項目のアラート条件：
    - 人生史：最終更新から6ヶ月（180日）以上経過
    - 日記：最終更新から7日以上経過
    - 持ち味レポ：最終更新から1ヶ月以上経過（新しく更新できるようになったらアラートが表示される）
    - WCMシート：最終更新から6ヶ月（180日）以上経過
    - マイルストーン：最終更新から1ヶ月以上経過
    - マイゴール：最終更新から6ヶ月以上経過

## 11. 「過去の自分を思い出す」機能の再構築

### 11.1 iPhoneの写真アプリ風レコメンド機能
- **過去記録の優先順位付け**
  - 同じ日付の過去の記録を最優先に表示（例：1年前の今日）
  - 次に同じ期間の記録を表示（例：同じ月の過去の記録）
  - 最後に最近の記録を表示

### 11.2 感情的なメッセージ生成
- **AIによるメッセージ生成**
  - `PastMemoryService`を新規作成
  - 過去の記録に対して感情的なメッセージを自動生成
  - 例：「1年前の今日、あなたはこんなことを考えていました」

### 11.3 UIの改善
- **視覚的に魅力的なカード表示**
  - 過去の記録をカード形式で表示
  - スライド形式で複数の記録を表示
  - 「●日前」のテキストを整数で表示（小数点以下を削除）

## 12. マイゴール機能の改善

### 12.1 AI解答例生成機能の追加
- **ユーザー入力に基づく解答例の自動生成**
  - ユーザーが質問に回答すると、AIがその内容を参照して解答例を自動生成
  - 「💡 回答例」と「✨ AIが生成した解答例」の両方に「（あなたが記載した内容から参照して生成されています）」という注釈を追加
  - `GoalRecommendationService`に`generateAnswerExample()`メソッドを追加

## 13. WCMフォームの改善

### 13.1 ナビゲーション機能の追加
- **ダッシュボードへの戻りボタン**
  - WCMフォームの下部に「保存してダッシュボードに戻る」ボタンを追加
  - `WcmForm`コンポーネントに`saveAndReturnToDashboard()`メソッドを追加

## 14. その他のUI改善

### 14.1 サイドバーの改善
- **サイドバー項目の順番変更**
  - サイドバー項目の順番を調整
  - 「プロフィール」セクションを追加（プロフィール、履歴書アップロード、職務経歴書アップロード）
  - すべてのサイドバー項目から`unlockedFeatures`条件分岐を削除（日記機能を常時利用可能にしたため）

### 14.2 ナビゲーションボタンの追加
- **各ページに「ダッシュボードに戻る」ボタンを追加**
  - 日記カレンダーページの下部に「ダッシュボードに戻る」ボタンを追加
  - 自己診断結果ページの下部に「ダッシュボードに戻る」ボタンを追加

### 14.3 リンクの更新
- **外部リンクの更新**
  - 「面談を申し込む」ボタンと「面談申し込み」サイドバー項目のリンクを`https://careerpartner.jp/carehugforI`に変更

### 14.4 AIアイコンの統一
- **キャリくまアイコンの使用**
  - 日記内省フィードバック画面の「AIからの内省フィードバック」見出しの左側にキャリくまアイコンを追加
  - フィードバックメッセージのアイコンを星アイコンからキャリくまアイコンに変更
  - ダッシュボードの「🔥」アイコンは元の状態に戻す（キャリくま画像を削除）

## 15. バグ修正

### 15.1 構文エラーの修正
- **LifeHistoryコンポーネントのParseError修正**
  - `app/Livewire/LifeHistory.php`の`save()`メソッドで、`if-else`ブロックの外に`MappingProgressService`の呼び出しを移動して構文エラーを修正

### 15.2 データベースエラーの修正
- **work_experience_yearsカラムの型変更**
  - `work_experience_years`カラムを`integer`型から`string`型に変更するマイグレーションを実装
  - 「現在は働いていない」オプション（`'not_working'`値）をサポート

## 16. コード品質の改善

### 16.1 サービスクラスの整理
- **PastMemoryServiceの新規作成**
  - 過去の記録を取得し、感情的なメッセージを生成する専用サービスを実装
  - `calculateTimeAgo()`メソッドで整数値を返すように修正

### 16.2 モデルの拡張
- **StrengthsReportモデルの実装**
  - `StrengthsReport`モデルを新規作成
  - `getLatestForUser()`と`canUpdate()`メソッドを実装

---

## 技術的な変更点

### データベースマイグレーション
1. `add_employment_type_to_users_table.php` - `employment_type`カラムの追加
2. `add_google_columns_to_users_table.php` - `google_id`と`avatar`カラムの追加
3. `add_diagnosis_and_diary_report_to_strengths_reports_table.php` - 持ち味レポに診断レポートと日記レポートカラムを追加
4. `change_work_experience_years_to_string_in_users_table.php` - `work_experience_years`カラムを`string`型に変更

### 新規作成されたファイル
- `app/Services/PastMemoryService.php`
- `app/Models/StrengthsReport.php`
- `app/Http/Controllers/Admin/ProfileStatsController.php`
- `app/Http/Controllers/Auth/GoogleAuthController.php`
- `app/Notifications/VerifyEmail.php`
- `resources/views/admin/profile-stats.blade.php`
- `resources/views/emails/verify-email.blade.php`

### 主要な変更ファイル
- `app/Livewire/Settings/Profile.php` - プロフィール編集機能の拡張
- `app/Livewire/ProfileSetup.php` - 雇用形態フィールドの追加
- `app/Livewire/CareerMilestoneForm.php` - 行動メモ自動生成機能の追加
- `app/Livewire/CareerMilestoneBoard.php` - 編集・削除・完了機能の追加
- `app/Services/ReflectionChatService.php` - プロンプト統合
- `app/Services/MappingProgressService.php` - メダルレベル基準とアラート機能の更新
- `resources/views/dashboard.blade.php` - UI/UXの大幅な改善
- `resources/views/components/layouts/app/sidebar.blade.php` - サイドバーの改善

---

**最終更新日**: 2025年12月19日

