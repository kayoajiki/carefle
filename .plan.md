# キャリフレ改善計画：ゲーミフィケーション重視のオンボーディングフロー（最終版）

## 概要

競合調査の知見を踏まえ、ユーザーの自己理解欲求を刺激し、継続利用を促進するオンボーディングフローを実装します。ゲーミフィケーション要素を取り入れ、達成感と成長実感を可視化します。

**核となるビジョン**: 
- 最初は本質だけを提示（プチ取説）
- ユーザーが入力内容を増やすことで、過去→現在→未来のマッピングが完成
- コンテキスト別（仕事、家族など）の取説が曼荼羅形式で段階的に生成
- キャリフレに戻ってくれば自分を思い出し、変容も見つめ直せる
- 将来的にナノバナナで画像化

## 実装内容

### Phase 1: オンボーディング進捗管理システム

#### 1.1 データベース設計
- **マイグレーション**: `create_onboarding_progress_table.php`
  - `user_id`, `current_step`, `completed_steps` (JSON), `started_at`, `completed_at`, `last_prompted_at`
  - ステップ: `diagnosis` (現職満足度診断), `diary_first` (初回日記), `assessment` (自己診断入力), `wcm_created` (WCMシート作成), `diary_7days` (7日間記録), `manual_generated` (プチ取説生成)
- **モデル**: `app/Models/OnboardingProgress.php`
  - 進捗状態の管理、完了チェック、次のステップ判定

#### 1.2 進捗追跡サービス
- **サービス**: `app/Services/OnboardingProgressService.php`
  - `checkStepCompletion()`: 各ステップの完了状態をチェック
  - `getNextStep()`: 次のステップを取得
  - `updateProgress()`: 進捗を更新
  - `isOnboardingComplete()`: オンボーディング完了判定
  - `shouldShowPrompt($step)`: プロンプトを表示すべきか判定（24時間以内に表示した場合は再表示しない）

### Phase 2: ダッシュボード進捗表示とガイド

#### 2.1 進捗バーコンポーネント
- **Livewire**: `app/Livewire/OnboardingProgressBar.php`
  - ダッシュボード上部に控えめな進捗バーを表示
  - 各ステップのアイコンと進捗率を表示
  - 完了したステップはチェックマーク、未完了はグレーアウト
  - クリックで各ステップの詳細ページへ遷移
  - **重要**: オンボーディング完了後は非表示（達成バッジのみ表示）

#### 2.2 機能の段階的提示システム
- **サービス**: `app/Services/FeatureDiscoveryService.php`
  - ユーザーの利用状況に応じて機能を段階的にアンロック
  - サイドバーメニューの表示制御（未アンロック機能は非表示または「ロック」表示）
  - 機能発見のタイミングでツールチップやバッジを表示

#### 2.3 サイドバーメニューの動的制御
- **実装箇所**: `resources/views/components/layouts/app/sidebar.blade.php`
  - オンボーディング未完了時は最小限のメニューのみ表示
  - 進捗に応じて機能を段階的に表示
  - 「こんなこともできます」という案内を適切なタイミングで表示

### Phase 3: ステップ別導線実装

#### 3.1 ステップ1: 現職満足度診断の促進

**初回ログイン時の挙動**:
- **実装箇所**: `app/Http/Responses/RegisterResponse.php`
- 初回ログイン時は自動で診断画面（`diagnosis.start`）にリダイレクト（現在の仕様を維持）
- 診断は途中保存可能で、いつでもダッシュボードに戻れる

**ダッシュボードでの促し**:
- **実装箇所**: `app/Http/Controllers/DashboardController.php`、`resources/views/dashboard.blade.php`
- 診断未完了ユーザーに対して、控えめなモーダル/オーバーレイで診断を促す
- **Livewireコンポーネント**: `app/Livewire/DiagnosisPromptModal.php`（新規作成）
  - 診断未完了かつ「後でやる」を選択してから24時間経過している場合のみ表示
  - モーダル/オーバーレイの表示/非表示を制御
  - 「診断を続ける」ボタンと「後でやる」ボタンを表示
  - 一度「後でやる」を選択したら、24時間は再表示しない（しつこくしない）
- 診断完了時に `OnboardingProgressService` で進捗更新

#### 3.2 ステップ2: 初回日記記録の促進

**ダッシュボードでの促し**:
- **実装箇所**: `app/Http/Controllers/DashboardController.php`、`resources/views/dashboard.blade.php`
- 診断完了かつ初回日記未記録の場合、ダッシュボード上にオーバーレイ/モーダルで「今日の振り返りを書く」を表示
- **Livewireコンポーネント**: `app/Livewire/DiaryPromptModal.php`（新規作成）
  - 診断完了かつ初回日記未記録の場合のみ表示
  - モーダル/オーバーレイの表示/非表示を制御
  - 「今日の振り返りを書く」ボタンと「後でやる」ボタンを表示
  - 一度「後でやる」を選択したら、24時間は再表示しない

**日記記録の体験**:
- **実装箇所**: 既存の日記記録機能を使用
- 診断結果を参照した日記テーマ提案は**不要**
- 通常の日記記録フォームを使用（`app/Livewire/DiaryForm.php`、`resources/views/livewire/diary-form.blade.php`）

**フィードバック**:
- **実装箇所**: 既存のAIフィードバック機能を使用
- 日記保存後のフィードバックは既存のAIフィードバックを使用（`app/Livewire/DiaryReflectionFeedback.php`）
- 特別な「めちゃ褒める」機能は追加しない

**進捗更新**:
- 初回日記保存時に `OnboardingProgressService` で進捗更新
- 次のアクション: 「自己診断結果を入力すると、もっと深い分析ができます」と案内

#### 3.3 ステップ3: 自己診断結果入力促進
- **実装箇所**: `app/Livewire/PersonalityAssessmentForm.php`
- 自己診断結果保存時に進捗更新
- ダッシュボードで「自己診断結果を1つ入力するとプチ取説が生成されます」と表示

#### 3.4 ステップ4: WCMシート作成促進
- **実装箇所**: `app/Livewire/WcmForm.php`
- WCMシート作成完了時に進捗更新
- ダッシュボードで「WCMシートを作成すると、未来の自分が見えてきます」と表示
- オンボーディング中は「未来の自分を描く」という文脈でWCM作成を促す
- WCM完了時に「未来の自分が描けました！次は7日間の日記を書いてみましょう」と案内

### Phase 4: 日記記録のゲーミフィケーション

#### 4.1 日記記録カウンター
- **実装箇所**: `app/Http/Controllers/DashboardController.php`
- 連続記録日数の表示（既存の `reflectionStreak` を活用）
- 7日間記録の進捗バー表示（例: 「あと3日でプチ取説が生成されます！」）

#### 4.2 日記保存時の褒め機能強化
- **実装箇所**: `app/Livewire/DiaryReflectionFeedback.php`
- 日記保存時にAIが「めちゃ褒める」フィードバックを生成
- プロンプトを「あなたの日記は素晴らしい！○○な視点が素敵です。続けることで...」のような励まし重視に調整
- 連続記録日数に応じた特別なメッセージ（3日、7日、14日など）

#### 4.3 進捗可視化
- **実装箇所**: `resources/views/dashboard.blade.php`
- 日記記録カレンダーをミニマップ形式で表示
- 7日間の記録状況を視覚的に表示
- 達成時にアニメーション演出

### Phase 5: プチ取説生成機能（本質のみ）

#### 5.1 診断結果統合分析サービス
- **サービス**: `app/Services/DiagnosisIntegrationService.php`
  - 複数の診断結果（MBTI、ストレングスファインダー、現職満足度診断など）を横断分析
  - 「共通して○○が強い」などの統合レポート生成
  - AI（Bedrock）を使用して自然な文章で統合解釈を生成
  - **重要**: 最初は本質だけを抽出（詳細は後から追加）

#### 5.2 日記分析サービス（初期版）
- **サービス**: `app/Services/DiaryAnalysisService.php`
  - 7日間の日記を分析し、価値観、強み、成長ポイントを抽出
  - AIを使用して日記の内容を統合し、ユーザーの傾向を分析
  - **重要**: 最初は表面的な分析のみ（深掘りは後から）

#### 5.3 プチ取説生成サービス（本質のみ）
- **サービス**: `app/Services/MiniManualGeneratorService.php`
  - `DiagnosisIntegrationService` と `DiaryAnalysisService` の結果を統合
  - ユーザー専用の「プチ取説」を生成（HTML形式）
  - **内容**: 本質のみ（統合診断結果の核心、日記から見える価値観の本質、強みの核心、次のステップ提案）
  - 詳細な分析は後から段階的に追加

#### 5.4 プチ取説表示ページ
- **ルート**: `GET /onboarding/mini-manual`
- **コントローラー**: `app/Http/Controllers/OnboardingController.php`
  - `showMiniManual()`: プチ取説を表示
  - `generateMiniManual()`: プチ取説を生成（初回のみ）
- **ビュー**: `resources/views/onboarding/mini-manual.blade.php`
  - 美しいレイアウトでプチ取説を表示
  - SNSシェアボタン（X、Instagram、Facebook）
  - PDFダウンロードボタン

#### 5.5 PDF生成機能（主要な共有方法）
- **ライブラリ**: `barryvdh/laravel-dompdf` または `spatie/laravel-pdf`
- **実装**: `app/Http/Controllers/OnboardingController.php`
  - `downloadMiniManualPdf()`: PDFを生成してダウンロード
  - プチ取説の内容をPDF形式で出力
  - **重要**: PDFはSNSシェア用に最適化されたレイアウト
  - PDFには「キャリフレで生成されたプチ取説」というクレジットを記載

#### 5.6 SNSシェア案内機能
- **実装**: `resources/views/onboarding/mini-manual.blade.php`
  - **基本方針**: データはすべて非公開、PDFをダウンロードしてSNSに投稿する形式
  - PDFダウンロードボタンを目立つ位置に配置
  - SNSシェア案内テキストを表示（例: 「PDFをダウンロードして、XやInstagramに投稿してみましょう」）
  - 各SNSの投稿方法を簡単に案内
    - X（Twitter）: PDFを添付して投稿
    - Instagram: PDFを画像として投稿、またはPDFのスクリーンショットを投稿
    - Facebook: PDFを添付して投稿
  - シェア用のテキストテンプレートを用意（「私のプチ取説が完成しました！#キャリフレ」など）

### Phase 6: コンテキスト別取説生成（段階的拡張）

#### 6.1 コンテキスト検出サービス
- **サービス**: `app/Services/ContextDetectionService.php`
  - 日記内容を分析してコンテキストを自動検出（仕事、家族、趣味、健康など）
  - AIを使用してコンテキストを分類
  - 各コンテキストの記録量を追跡

#### 6.2 コンテキスト別取説生成サービス
- **サービス**: `app/Services/ContextualManualGeneratorService.php`
  - 特定コンテキスト（例: 仕事）の日記が一定量（例: 5件以上）蓄積されたら生成
  - 「仕事の自分」「家族の自分」などのコンテキスト別取説を生成
  - プチ取説と同様の構造だが、コンテキスト特化の内容

#### 6.3 コンテキスト別取説表示
- **ルート**: `GET /manual/context/{context}`
- **コントローラー**: `app/Http/Controllers/ManualController.php`
  - コンテキスト別取説を表示
  - 複数のコンテキスト取説を一覧表示

### Phase 7: 曼荼羅形式のマッピング（過去→現在→未来）

#### 7.1 マッピングデータ構造
- **モデル**: `app/Models/UserMapping.php`
  - `user_id`, `mapping_type` (past/current/future), `context` (work/family/etc), `data` (JSON), `generated_at`
- **マイグレーション**: `create_user_mappings_table.php`

#### 7.2 マッピング生成サービス
- **サービス**: `app/Services/UserMappingService.php`
  - 過去の記録（人生史、過去の日記）から「過去の自分」をマッピング
  - 現在の記録（最新の診断、日記）から「現在の自分」をマッピング
  - 未来の記録（WCM、マイルストーン）から「未来の自分」をマッピング
  - 3つのマッピングを統合して曼荼羅形式で可視化
  - **重要**: 曼荼羅の構造は外側=未来、中央=現在、内側=過去とする

#### 7.3 曼荼羅形式の可視化
- **Livewire**: `app/Livewire/UserMappingVisualization.php`
  - 曼荼羅形式で表示（外側=未来、中央=現在、内側=過去）
  - 外側の輪：未来の自分（WCMのWill/Can/Must、マイルストーン）
  - 中央の輪：現在の自分（最新の診断結果、最近の日記）
  - 内側の輪：過去の自分（過去の診断、過去の日記、人生史）
  - 各コンテキスト（仕事、家族など）をセクションとして配置
  - インタラクティブなマップ（クリックで詳細表示）

#### 7.4 変容追跡機能
- **サービス**: `app/Services/TransformationTrackingService.php`
  - 過去の自分と現在の自分を比較
  - 変容ポイントをハイライト
  - 成長グラフを生成

### Phase 8: 自分を思い出す機能

#### 8.1 過去の記録へのアクセス
- **実装箇所**: `resources/views/dashboard.blade.php`
  - 「過去の自分を思い出す」セクションを追加
  - 過去の日記、診断結果、取説へのクイックアクセス

#### 8.2 変容の可視化
- **実装箇所**: `resources/views/manual/mapping.blade.php`
  - 過去→現在→未来の変容を時系列で表示
  - 変容の大きさを視覚的に表示

### Phase 9: 将来的な拡張（ナノバナナ統合）

#### 9.1 ナノバナナ画像生成準備
- **サービス**: `app/Services/NanobananaImageService.php` (既存を拡張)
  - 曼荼羅形式の取説を画像として生成
  - カスタマイズ可能なスタイル

#### 9.2 画像化機能
- **実装**: 将来的に実装
  - 取説を画像としてエクスポート
  - SNSシェア用の画像生成

## 実装順序

1. **Phase 1-2**: オンボーディング進捗管理とダッシュボード表示
2. **Phase 3**: ステップ別導線実装（ステップ1-4）
3. **Phase 4**: 日記記録のゲーミフィケーション
4. **Phase 5**: プチ取説生成（本質のみ）
5. **Phase 6**: コンテキスト別取説生成（段階的）
6. **Phase 7**: 曼荼羅形式のマッピング（外側=未来、内側=過去）
7. **Phase 8**: 自分を思い出す機能
8. **Phase 9**: 将来的な拡張（ナノバナナ統合）

## 技術的な考慮事項

- **AI統合**: AWS Bedrockを使用して診断結果の統合分析と日記分析を実装
- **パフォーマンス**: プチ取説生成は非同期処理（ジョブキュー）を検討
- **キャッシュ**: 生成済みプチ取説はキャッシュして再生成を避ける
- **エラーハンドリング**: AI生成失敗時のフォールバック処理を実装
- **プライバシー**: データは暗号化し、ユーザー自身のみがアクセス可能
- **機能の段階的提示**: 混乱を避けるため、必要に応じて機能をアンロック

## 関連ファイル

### 新規作成
- `app/Models/OnboardingProgress.php`
- `app/Models/UserMapping.php`
- `app/Services/OnboardingProgressService.php`
- `app/Services/FeatureDiscoveryService.php`
- `app/Services/DiagnosisIntegrationService.php`
- `app/Services/DiaryAnalysisService.php`
- `app/Services/MiniManualGeneratorService.php`
- `app/Services/ContextDetectionService.php`
- `app/Services/ContextualManualGeneratorService.php`
- `app/Services/UserMappingService.php`
- `app/Services/TransformationTrackingService.php`
- `app/Http/Controllers/OnboardingController.php`
- `app/Http/Controllers/ManualController.php`
- `app/Livewire/OnboardingProgressBar.php`
- `app/Livewire/UserMappingVisualization.php`
- `app/Livewire/DiagnosisPromptModal.php`（新規）
- `app/Livewire/DiaryPromptModal.php`（新規）
- `resources/views/onboarding/mini-manual.blade.php`
- `resources/views/manual/context.blade.php`
- `resources/views/manual/mapping.blade.php`

### 更新
- `resources/views/dashboard.blade.php`
- `app/Http/Controllers/DashboardController.php`
- `app/Livewire/DiaryReflectionFeedback.php`
- `resources/views/components/layouts/app/sidebar.blade.php`
- `resources/views/diagnosis/result.blade.php`
- `app/Livewire/PersonalityAssessmentForm.php`
- `app/Livewire/WcmForm.php`
- `app/Http/Responses/RegisterResponse.php`

